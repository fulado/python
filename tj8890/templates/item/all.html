{% extends 'base.html' %}

{% block head %}
    <script type="text/javascript">
        $(function() {
            // 日期组件初始化
            $('.datetime-picker').datetimepicker({
                language: 'zh-CN',          //显示中文
                format: 'yyyy-mm-dd',       //显示格式
                minView: 2,                 //设置只显示到月份
                initialDate: new Date(),    //初始化当前日期
                autoclose: true,            //选中自动关闭
                todayBtn: true              //显示今日按钮
            });

            // 事项二类选择后, 三类对应变化
            $('.search select').eq(1).change(function() {
                var val = $(this).val();
                if (val == 0) {
                    $('.search select').eq(2).val(0);
                    $('.search select').eq(2).attr("disabled","disabled");
                } else {
                    $('.search select').eq(2).removeAttr("disabled");
                    var cate3 = $('.search input:hidden').eq(0).val();
                    setCateInfo($(this), $('.search select').eq(2));
                }

                $('.search select').eq(2).change();
            });

            // 事项三类选择后, 四类对应变化
            $('.search select').eq(2).change(function() {
                var val = $(this).val();
                if (val == 0) {
                    $('.search select').eq(3).val(0);
                    $('.search select').eq(3).attr("disabled","disabled");
                } else {
                    $('.search select').eq(3).removeAttr("disabled");
                    var cate4 = $('.search input:hidden').eq(1).val();
                    setCateInfo($(this), $('.search select').eq(3), cate4);
                }
            });

            // 选择的开始时间不能大于结束时间
            $('.datetime-picker').eq(0).datetimepicker().click(function() {
                var endTime = $('.datetime-picker').eq(1).val();
                $('.datetime-picker').eq(0).datetimepicker("setEndDate", endTime)
            });
            $('.datetime-picker').eq(2).datetimepicker().click(function() {
                var endTime = $('.datetime-picker').eq(3).val();
                $('.datetime-picker').eq(2).datetimepicker("setEndDate", endTime)
            });

            // 选择的结束时间不能小于开始时间
            $('.datetime-picker').eq(1).datetimepicker().click(function() {
                var startTime = $('.datetime-picker').eq(0).val();
                $('.datetime-picker').eq(1).datetimepicker("setStartDate", startTime)
            });
            $('.datetime-picker').eq(3).datetimepicker().click(function() {
                var startTime = $('.datetime-picker').eq(2).val();
                $('.datetime-picker').eq(3).datetimepicker("setStartDate", startTime)
            });

            //
            // $('#export_excel').click(function () {
            //     $('#importModal').hide();
            // });
        });

        // 重置查询选项
        function resetSearchInfo() {
            // 获取服务器给的默认时间
            var default_time_begin = $('.search input:hidden').eq(1).val();
            var default_time_end = $('.search input:hidden').eq(2).val();

            // 重置时间
            $('.datetime-picker').eq(0).val(default_time_begin);
            $('.datetime-picker').eq(1).val(default_time_end);

            // 重置事项分类
            $('.search input').eq(2).val('');

            // 重置流转情况
            $('.search select').eq(0).val(0);

            // 重置紧急程度
            $('.search select').eq(1).val(0);
        }

        // 选择不同的上级选项, 下级选择框相应变化
        function setCateInfo(parentObj, childObj, childId) {
            // 设置查询下级复选框登记
            var childId = childId || 0;
            // 用户选择上级选项的id
            var parent_id = parentObj.val();
            // 通过Ajax获取二级部门
            $.get('/item/cate_search', {'parent_id': parent_id}, function(data) {
                // 清空二级部门选择中的全部选项
                childObj.empty();
                // 根据查询结果, 添加二级部门子元素
                var newOption = $('<option></option>').val(0).text('全部');
                childObj.append(newOption);
                for (i in data.cate_list) {
                    if (childId == data.cate_list[i].id) {
                        var newOption = $('<option selected></option>').val(data.cate_list[i].id).text(data.cate_list[i].name);
                    } else {
                        var newOption = $('<option></option>').val(data.cate_list[i].id).text(data.cate_list[i].name);
                    }
                    childObj.append(newOption);
                }
            });
        }

        function submitImportFile() {
            // 判断是否选择文件
            if ($('.selFile input').val().length > 0) {
                var oForm = $('#importExcel');
                submitForm(oForm, 'POST', '/item/import_excel');
            } else {
                alert('请选择需要导入的文件');
            }
        }
    </script>
{% endblock %}}

<!-- 当前位置 -->
{% block location %}
    <div class="location">
        <p><span>{{ request.session.title.0 }}</span>&nbsp;>&nbsp;<span>{{ request.session.title.1 }}</span></p>
        <!-- 搜索框 -->
        <!--<div class="input-group">-->
            <!--<label for="search01" id="search01_label">请输入关键字</label>-->
            <!--<input type="text" class="form-control" id="search01" />-->
            <!--<span class="input-group-btn">-->
                <!--<button class="btn btn-default" type="button">-->
                    <!--<span class="glyphicon glyphicon-search"></span>-->
                <!--</button>-->
            <!--</span>-->
        <!--</div>-->
    </div>
    <div class="bar01"></div>

{% endblock %}

<!-- 检索/添加 -->
{% block search %}
    <!-- 事件检索 -->
    <div class="search">
        <!-- 导入导出按钮 -->
        {% if request.session.authority == 2 %}
        <div class="import-group">
            <a class="btn btn-default" data-toggle="modal" data-target="#importModal" data-backdrop="static">导入事项</a>
            <a class="btn btn-default" data-toggle="modal" data-target="#exportModal" data-backdrop="static">导出事项</a>
        </div>
        {% endif %}

        <form action="/item/all" method="GET">
            <table>
                <tr>
                    <td><span>接件时间</span></td>
                    <td>
                        <input type="text" class="datetime-picker" name="accept_time_begin" value="{{ request.session.accept_time_begin }}">
                        ~
                        <input type="text" class="datetime-picker" name="accept_time_end" value="{{ request.session.accept_time_end }}">
                    </td>
                    <td></td>
                    <td><span>求助类别</span></td>
                    <td>
                        <select name="cate">
                            {% if request.session.cate == 0 %}
                            <option value="0" selected>全部</option>
                            {% else %}
                            <option value="0">全部</option>
                            {% endif %}
                            {% for cate in cate_list %}
                            {% if request.session.cate == cate.id %}
                            <option value="{{ cate.id }}" selected>{{ cate.name }}</option>
                            {% else %}
                            <option value="{{ cate.id }}">{{ cate.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><span>关键字检索</span></td>
                    <td>
                        <input type="text" placeholder="请输入关键字" name="keyword" value="{{ request.session.keyword|default:'' }}">
                    </td>
                    <td></td>
                    <td><span>紧急程度</span></td>
                    <td>
                        <select name="emergency">
                            {% for e in emergency_list %}
                            {% if request.session.emergency == forloop.counter|add:-1 %}
                            <option value="{{ forloop.counter|add:-1 }}" selected>{{ e }}</option>
                            {% else %}
                            <option value="{{ forloop.counter|add:-1 }}">{{ e }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            </table>
            <div class="search-btn-group">
                <input type="submit" class="btn btn-default"  value="查询" />
                <a href="javascript:resetSearchInfo();" class="btn btn-default">重置</a>
            </div>
            <input type="hidden" value="{{ request.session.status }}" name="status" />
            <input type="hidden" value="{{ request.session.default_time_begin }}"/>
            <input type="hidden" value="{{ request.session.default_time_end }}"/>
        </form>
    </div>
{% endblock %}

<!-- 检索结果 -->
{% block result %}
<!-- 检索结果 -->
    <div class="result">
        <div class="bar02"></div>
        <table class="table table-striped table-hover text-center">
            <thead>
                <tr>
                    <td style="width:15%;">事项编号</td>
                    <td>内容摘要</td>
                    <td style="width:8%;">紧急程度</td>
                    <td style="width:8%;">流转情况</td>
                    <td style="width:15%;">接件时间</td>
                    <td style="width:15%;">承办时限</td>
                    <td style="width:10%;">办理单位</td>
                    <td style="width:8%;">操作</td>
                </tr>
            </thead>
            <tbody>
                {% for item in mp.object_list %}
                    <tr>
                        <td>{{ item.id }}</td>
                        <td title="{{ item.content|default:'' }}">{{ item.content|default:'' }}</td>
                        {% if item.emergency == 1 %}
                            <td>普通(3天)</td>
                            {% elif item.emergency == 2 %}
                            <td>加急(2天)</td>
                            {% elif item.emergency == 3 %}
                            <td>紧急(当日回复)</td>
                            {% elif item.emergency == 4 %}
                            <td>特急(两小时内回复)</td>
                        {% endif %}
                        <td>{{ item.status.status_name|default:'' }}</td>
                        <td>{{ item.accept_time|date:'Y-m-d H:i:s'|default:'' }}</td>
                        <td>{{ item.limit_time|date:'Y-m-d H:i:s'|default:'' }}</td>
                        <td>{{ item.assign_dept.name|default:'' }}</td>
                        <td><a href="/item/detail?id={{ item.id }}"><button class="btn btn-default">查看</button></a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

<!-- 分页 -->
{% block page %}
    <!-- 分页 -->
    <div class="divide-page">
        <form action="/item/all" method="GET" class="goto">
            <span>到</span>
                <input type="text" name="page_num" />
                <input type="hidden" name="accept_time_begin" value="{{ request.session.accept_time_begin }}" />
                <input type="hidden" name="accept_time_end" value="{{ request.session.accept_time_end }}" />
                <input type="hidden" name="cate" value="{{ request.session.cate }}" />
                <input type="hidden" name="status" value="{{ request.session.status }}" />
                <input type="hidden" name="emergency" value="{{ request.session.emergency }}" />
                <input type="hidden" name="keyword" value="{{ request.session.keyword }}" />
            <span>页</span>
        </form>
        <p class="current-total">
            共<span>{{ mp.total_pages }}</span>页/<span>{{ mp.total_objects }}</span>条数据
        </p>

        <ul class="page">
            <a href="/item/all?page_num=1&accept_time_begin={{ request.session.accept_time_begin }}&accept_time_end={{ request.session.accept_time_end }}&cate={{ request.session.cate }}&status={{ request.session.status }}&emergency={{ request.session.emergency }}&keyword={{ request.session.keyword }}"><li>首页</li></a>
            <a href="/item/all?page_num={{ mp.current_num|add:-1 }}&accept_time_begin={{ request.session.accept_time_begin }}&accept_time_end={{ request.session.accept_time_end }}&cate={{ request.session.cate }}&status={{ request.session.status }}&emergency={{ request.session.emergency }}&keyword={{ request.session.keyword }}"><li>上一页</li></a>
            {% for num in mp.page_range %}
                {% if num == mp.current_num %}
                <a href="/item/all?page_num={{ num }}&accept_time_begin={{ request.session.accept_time_begin }}&accept_time_end={{ request.session.accept_time_end }}&cate={{ request.session.cate }}&status={{ request.session.status }}&emergency={{ request.session.emergency }}&keyword={{ request.session.keyword }}"><li class="number current-page">{{ num }}</li></a>
                {% else %}
                <a href="/item/all?page_num={{ num }}&accept_time_begin={{ request.session.accept_time_begin }}&accept_time_end={{ request.session.accept_time_end }}&cate={{ request.session.cate }}&status={{ request.session.status }}&emergency={{ request.session.emergency }}&keyword={{ request.session.keyword }}"><li class="number">{{ num }}</li></a>
                {% endif %}
            {% endfor %}
            <a href="/item/all?page_num={{ mp.current_num|add:1 }}&accept_time_begin={{ request.session.accept_time_begin }}&accept_time_end={{ request.session.accept_time_end }}&cate={{ request.session.cate }}&status={{ request.session.status }}&emergency={{ request.session.emergency }}&keyword={{ request.session.keyword }}"><li>下一页</li></a>
            <a href="/item/all?page_num={{ mp.total_pages }}&accept_time_begin={{ request.session.accept_time_begin }}&accept_time_end={{ request.session.accept_time_end }}&cate={{ request.session.cate }}&status={{ request.session.status }}&emergency={{ request.session.emergency }}&keyword={{ request.session.keyword }}"><li>末页</li></a>
        </ul>
    </div>
{% endblock %}

{% block operate %}
    <!--上传文件模态框-->
    <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;
                    </button>
                    <h4 class="modal-title" id="importModalLabel">导入数据</h4>
                </div>
                <div class="modal-body">
                    <form enctype="multipart/form-data" method="post" id="importExcel">
                        {% csrf_token %}
                        <div class="selFile">
                            <!--<label for="reason" style="">选择文件</label>-->
                            <input type="file" name="excel_file" style="outline: none;cursor: pointer; width:300px; margin-left: 100px;" accept="application/vnd.ms-excel"/>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" onclick="submitImportFile()">确定</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <!--下载文件模态框-->
    <div class="modal fade" id="exportModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <form action="/item/export_excel">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;
                        </button>
                        <h4 class="modal-title" id="exportModalLabel">导出数据</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            <span>办结事项日期</span>&nbsp;&nbsp;
                            <input type="text" class="datetime-picker" name="save_time" value="{% now 'Y-m-d' %}">
                        </p>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="btn btn-primary" id="export_excel" value="确定"></a>
                        <!--<button type="button" class="btn btn-default" data-dismiss="modal" id="export_excel">确定</button>-->
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </form>
        </div><!-- /.modal -->
    </div>
{% endblock %}