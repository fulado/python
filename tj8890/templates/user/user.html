{% extends 'base.html' %}

{% block head %}
    <style type="text/css">
        .modal-dialog{
            height: 500px;
        }
    </style>

    <script type="text/javascript">
        $(function() {
            // 人员检索添加框, 选择不同的一级部门, 二级部门的选项相应变化
            $('.search .custom-select').first().change(function(data) {
                setDeptInfo($(this),  $('.search .custom-select').last());
            });

            // 添加人员模态框, 选择不同的一级部门, 二级部门的选项相应变化
            $('#addModal .modal-body select').first().change(function(data) {
                setDeptInfo($(this),  $('#addModal .modal-body select').eq(1));
            });
        });

        // 选择不同的一级部门, 二级部门的选项相应变化
        function setDeptInfo(supervisorObj, deptObj) {
            // 用户选择的一级部门id
            var supervisor_id = supervisorObj.val();
            // 通过Ajax获取二级部门
            $.get('/user/dept_search', {'supervisor_id': supervisor_id}, function(data) {
                // 清空二级部门选择中的全部选项
                deptObj.children().remove();
                // 根据查询结果, 添加二级部门子元素
                for (i in data.dept_list) {
                    var newOption = $('<option></option>');
                    newOption.val(data.dept_list[i].id);
                    newOption.text(data.dept_list[i].name);
                    deptObj.append(newOption);
                }
            });
        }
    </script>
{% endblock %}

<!-- 检索/添加 -->
{% block search %}
    <!-- 人员检索/添加 -->
    <div class="search">
        <p>部门选择&nbsp;:</p>
        <form action="/user/user" method="GET">
            <select class="custom-select" name="supervisor_id">
                {% for supervisor in supervisor_list %}
                    {% if supervisor.id == supervisor_id %}
                    <option value="{{ supervisor.id }}" selected>{{ supervisor.name }}</option>
                    {% else %}
                    <option value="{{ supervisor.id }}">{{ supervisor.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <select class="custom-select" id="dept02" name="dept_id">
                {% for dept in dept_list %}
                {% if dept.id == dept_id %}
                    <option value="{{ dept.id }}" selected>{{ dept.name }}</option>
                    {% else %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <div class="search-btn-group">
                <input type="submit" class="btn btn-default"  value="查询" />
                <a href="javascript:void(0)" class="btn btn-default" data-toggle="modal" data-target="#addModal" data-backdrop="static">添加</a>
                <a href="javascript:void(0)" class="btn btn-default">重置</a>
            </div>
        </form>
    </div>
{% endblock %}

<!-- 操作窗口 -->
{% block operate %}
    <!-- 模态框（Modal） -->
    <!-- 添加人员窗口 -->
    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;
                    </button>
                    <h4 class="modal-title" id="addModalLabel">添加人员</h4>
                </div>
                <form action="/user/user_add" method="GET">
                    <div class="modal-body">
                        <table>
                            <tr>
                                <td><span>所属单位</span></td>
                                <td>
                                    <select name="supervisor_id">
                                        {% for supervisor in supervisor_list %}
                                        <option value="{{ supervisor.id }}">{{ supervisor.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td></td>
                                <td><span>所属科室</span></td>
                                <td>
                                    <select name="dept_id">
                                        {% for dept in dept_list %}
                                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><span>姓名</span></td>
                                <td><input type="text" name="real_name" /></td>
                                <td></td>
                                <td><span>登陆账号:</span></td>
                                <td><input type="text" name="username" /></td>
                            </tr>
                            <tr>
                                <td><span>职务</span></td>
                                <td>
                                    <select name="duty">
                                        <option value="警员">警员</option>
                                        <option value="协警">协警</option>
                                        <option value="科长">科长</option>
                                    </select>
                                </td>
                                <td></td>
                                <td><span>登陆密码</span></td>
                                <td><input type="text" name="password" /></td>
                            </tr>
                            <tr>
                                <td><span>警号</span></td>
                                <td><input type="text" name="number" /></td>
                                <td></td>
                                <td><span>管理权限</span></td>
                                <td>
                                    <select name="authority">
                                        <option value="1" selected>管理员</option>
                                        <option value="2">管理端用户</option>
                                        <option value="3">客户端用户</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><span>联系电话</span></td>
                                <td><input type="text" name="phone" /></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="btn btn-primary" value="添加" />
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
{% endblock %}

<!-- 检索结果 -->
{% block result %}
    <div class="result">
        <div class="bar02"></div>
        <table class="table table-striped table-hover text-center">
            <thead>
                <tr>
                    <td>单位</td>
                    <td>科室</td>
                    <td>姓名</td>
                    <td>职务</td>
                    <td>警号</td>
                    <td>联系电话</td>
                    <td>操作</td>
                </tr>
            </thead>
            <tbody>
                {% for user in mp.object_list %}
                <tr>
                    <td>{{ user.dept.supervisor.name }}</td>
                    <td>{{ user.dept.name }}</td>
                    <td>{{ user.real_name }}</td>
                    <td>{{ user.duty }}</td>
                    <td>{{ user.number }}</td>
                    <td>{{ user.phone }}</td>
                    <td><button onclick="javascript:void(0)" class="btn btn-default" data-toggle="modal" data-target="#editModal" data-backdrop="static">编辑</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- 编辑人员窗口 -->
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;
                    </button>
                    <h4 class="modal-title" id="editModalLabel">编辑人员</h4>
                </div>
                <form action="#" method="GET">
                    <div class="modal-body">
                        <table>
                            <tr>
                                <td><span>所属单位</span></td>
                                <td>
                                    <select name="supervisor_id">
                                        <option value="1" selected>指挥室</option>
                                        <option value="14">安监处</option>
                                        <option value="21">车管所</option>
                                        <option value="34">法制办</option>
                                        <option value="38">后保处</option>
                                    </select>
                                </td>
                                <td></td>
                                <td><span>所属科室</span></td>
                                <td>
                                    <select name="dept_id">
                                        <option value="1" selected>一科</option>
                                        <option value="14">三科</option>
                                        <option value="21">四科</option>
                                        <option value="34">五科</option>
                                        <option value="38">二科</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><span>姓名</span></td>
                                <td><input type="text" name="real_name" value="张亮" /></td>
                                <td></td>
                                <td><span>登陆账号:</span></td>
                                <td><input type="text" name="username" value="admin" /></td>
                            </tr>
                            <tr>
                                <td><span>职务</span></td>
                                <td>
                                    <select name="duty">
                                        <option value="1" selected>警员科</option>
                                        <option value="14">协警</option>
                                        <option value="21">科长</option>
                                    </select>
                                </td>
                                <td></td>
                                <td><span>登陆密码</span></td>
                                <td><input type="text" name="password" value="123456" /></td>
                            </tr>
                            <tr>
                                <td><span>警号</span></td>
                                <td><input type="text" name="number" value="654321" /></td>
                                <td></td>
                                <td><span>管理权限</span></td>
                                <td>
                                    <select name="authority">
                                        <option value="1" selected>管理员</option>
                                        <option value="14">管理端用户</option>
                                        <option value="21">客户端用户</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><span>联系电话</span></td>
                                <td><input type="text" name="phone" value="13901236789" /></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="btn btn-primary" value="添加" />
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
{% endblock %}

<!-- 分页 -->
{% block page %}
    <div class="divide-page">
        <form action="/user/dept" method="GET" class="goto">
            <span>到</span>
                <input type="hidden" name="supervisor_id" value="{{ supervisor.id }}"/>
                <input type="text" name="page_num" />
            <span>页</span>
        </form>
        <p class="current-total">
            共<span>{{ mp.total_pages }}</span>页/<span>{{ mp.total_objects }}</span>条数据
        </p>

        <ul class="page">
            <a href="/user/dept?supervisor_id={{ supervisor.id }}&page_num=1"><li>首页</li></a>
            <a href="/user/dept?supervisor_id={{ supervisor.id }}&page_num={{ mp.current_num|add:-1 }}"><li>上一页</li></a>
            {% for num in mp.page_range %}
                {% if num == mp.current_num %}
                <a href="/user/dept?supervisor_id={{ supervisor.id }}&page_num={{ num }}"><li class="number current-page">{{ num }}</li></a>
                {% else %}
                <a href="/user/dept?supervisor_id={{ supervisor.id }}&page_num={{ num }}"><li class="number">{{ num }}</li></a>
                {% endif %}
            {% endfor %}
            <a href="/user/dept?supervisor_id={{ supervisor.id }}&page_num={{ mp.current_num|add:1 }}"><li>下一页</li></a>
            <a href="/user/dept?supervisor_id={{ supervisor.id }}&page_num={{ mp.total_pages }}"><li>末页</li></a>
        </ul>
    </div>
{% endblock %}